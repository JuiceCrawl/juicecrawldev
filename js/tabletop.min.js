!function(e){"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){null==t?t=0:0>t&&(t=Math.max(0,this.length+t));for(var s=t,n=this.length;n>s;s++)if(this[s]===e)return s;return-1});var t=e.Tabletop=function(e){return this&&this instanceof t?("string"==typeof e&&(e={key:e}),this.callback=e.callback,this.wanted=e.wanted||[],this.key=e.key,this.simpleSheet=!!e.simpleSheet,this.parseNumbers=!!e.parseNumbers,this.wait=!!e.wait,this.postProcess=e.postProcess,this.debug=!!e.debug,this.query=e.query||"",/key=/.test(this.key)&&(this.log("You passed a key as a URL! Attempting to parse."),this.key=this.key.match("key=(.*?)&")[1]),this.key?(this.log("Initializing with key "+this.key),this.models={},this.model_names=[],this.base_json_url="https://spreadsheets.google.com/feeds/worksheets/"+this.key+"/public/basic?alt=json-in-script",void(this.wait||this.fetch())):void alert("You need to pass Tabletop a key!")):new t(e)};t.callbacks={},t.init=function(e){return new t(e)},t.sheets=function(){alert("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")},t.prototype={fetch:function(e){"undefined"!=typeof e&&(this.callback=e),this.injectScript(this.base_json_url,this.loadSheets)},injectScript:function(e,s){var n=document.createElement("script"),i=this,o="tt"+ +new Date+Math.floor(1e5*Math.random());t.callbacks[o]=function(){var e=Array.prototype.slice.call(arguments,0);s.apply(i,e),n.parentNode.removeChild(n),delete t.callbacks[o]},e=e+"&callback=Tabletop.callbacks."+o,n.src=e,document.getElementsByTagName("script")[0].parentNode.appendChild(n)},isWanted:function(e){return 0===this.wanted.length?!0:-1!=this.wanted.indexOf(e)},data:function(){return 0===this.model_names.length?void 0:this.simpleSheet?(this.model_names.length>1&&this.debug&&console.debug("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong."),this.models[this.model_names[0]].all()):this.models},addWanted:function(e){-1==this.wanted.indexOf(e)&&this.wanted.push(e)},loadSheets:function(e){var t,s,n=[];for(t=0,s=e.feed.entry.length;s>t;t++)if(this.isWanted(e.feed.entry[t].content.$t)){var i=e.feed.entry[t].link[3].href.substr(e.feed.entry[t].link[3].href.length-3,3),o="https://spreadsheets.google.com/feeds/list/"+this.key+"/"+i+"/public/values?alt=json-in-script&sq="+this.query;this.log(o),n.push(o)}for(this.sheetsToLoad=n.length,t=0,s=n.length;s>t;t++)this.injectScript(n[t],this.loadSheet)},sheets:function(e){return"undefined"==typeof e?this.models:"undefined"==typeof this.models[e]?void 0:this.models[e]},loadSheet:function(e){var s=new t.Model({data:e,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this});this.models[s.name]=s,-1==this.model_names.indexOf(s.name)&&this.model_names.push(s.name),this.sheetsToLoad--,0===this.sheetsToLoad&&this.doCallback()},doCallback:function(){0===this.sheetsToLoad&&this.callback.apply(this.callbackContext||this,[this.data(),this])},log:function(){this.debug&&"undefined"!=typeof console&&"undefined"!=typeof console.log&&Function.prototype.apply.apply(console.log,[console,arguments])}},t.Model=function(e){var t,s,n,i;if(this.column_names=[],this.name=e.data.feed.title.$t,this.elements=[],this.raw=e.data,"undefined"==typeof e.data.feed.entry)return e.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers"),void(this.elements=[]);for(var o in e.data.feed.entry[0])/^gsx/.test(o)&&this.column_names.push(o.replace("gsx$",""));for(t=0,n=e.data.feed.entry.length;n>t;t++){for(var a=e.data.feed.entry[t],h={},s=0,i=this.column_names.length;i>s;s++){var l=a["gsx$"+this.column_names[s]];h[this.column_names[s]]=e.parseNumbers&&""!==l.$t&&!isNaN(l.$t)?+l.$t:l.$t}void 0===h.rowNumber&&(h.rowNumber=t+1),e.postProcess&&e.postProcess(h),this.elements.push(h)}},t.Model.prototype={all:function(){return this.elements},toArray:function(){var e,t,s,n,i=[];for(e=0,s=this.elements.length;s>e;e++){var o=[];for(t=0,n=this.column_names.length;n>t;t++)o.push(this.elements[e][this.column_names[t]]);i.push(o)}return i}}}(this);